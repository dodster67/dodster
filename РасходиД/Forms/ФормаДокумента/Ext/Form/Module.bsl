&НаКлиенте
Процедура СебестоимостьКоличествоПриИзменении(Элемент)
    ПересчитатьСуммуМатериала(Элемент.ТекущиеДанные);
КонецПроцедуры

&НаКлиенте
Процедура СебестоимостьЦенаПриИзменении(Элемент)
    ПересчитатьСуммуМатериала(Элемент.ТекущиеДанные);
КонецПроцедуры

&НаКлиенте
Процедура ПересчитатьСуммуМатериала(СтрокаТаблицы)
    Если СтрокаТаблицы = Неопределено Тогда
        Возврат;
    КонецЕсли;
    
    СтрокаТаблицы.Сумма = СтрокаТаблицы.Количество * СтрокаТаблицы.Цена;
КонецПроцедуры

&НаКлиенте
Процедура НоменклатураПриИзменении(Элемент)
    // Очищаем обе табличные части
    Объект.Себестоимость.Очистить();
    Объект.Труды.Очистить();
    
    Если Не ЗначениеЗаполнено(Объект.Номенклатура) Тогда
        Возврат;
    КонецЕсли;
    
    // Заполняем на сервере
    ЗаполнитьСебестоимостьПоСпецификацииНаСервере(Объект.Номенклатура);
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСебестоимостьПоСпецификацииНаСервере(ГотоваяПродукция)
    
    // Ищем активную спецификацию для этого изделия
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ ПЕРВЫЕ 1
    |   Спецификации.Ссылка КАК Спецификация
    |ИЗ
    |   Справочник.Спецификации КАК Спецификации
    |ГДЕ
    |   Спецификации.Выходное_изделие = &Изделие
    |   И Спецификации.Статус = &СтатусАктивная
    |   И НЕ Спецификации.ПометкаУдаления";
    
    Запрос.УстановитьПараметр("Изделие", ГотоваяПродукция);
    Запрос.УстановитьПараметр("СтатусАктивная", Перечисления.Статус.Активная);
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    Если Не Выборка.Следующий() Тогда
        Сообщить("Не найдена активная спецификация для " + ГотоваяПродукция);
        Возврат;
    КонецЕсли;
    
    СпецификацияСсылка = Выборка.Спецификация;
    СпецификацияОбъект = СпецификацияСсылка.ПолучитьОбъект();
    
    // ЗАПОЛНЯЕМ МАТЕРИАЛЫ (табличная часть "Себестоимость")
    Для Каждого СтрокаМатериала Из СпецификацияОбъект.Материалы Цикл
        НоваяСтрока = Объект.Себестоимость.Добавить();
        НоваяСтрока.Материал = СтрокаМатериала.Материал;
        НоваяСтрока.Количество = СтрокаМатериала.Количество;
        
        // Получаем цену из последней закупки
        НоваяСтрока.Цена = ПолучитьЦенуМатериалаИзЗакупок(СтрокаМатериала.Материал);
        НоваяСтрока.Сумма = НоваяСтрока.Количество * НоваяСтрока.Цена;
    КонецЦикла;
    
    // ЗАПОЛНЯЕМ ТРУДОЗАТРАТЫ (табличная часть "Труды")
    Для Каждого СтрокаТрудозатрат Из СпецификацияОбъект.ТрудозатратыПоЭтапам Цикл
        НоваяСтрока = Объект.Труды.Добавить();
        НоваяСтрока.ВидРаботы = СтрокаТрудозатрат.ВидРабот;
        НоваяСтрока.Трудозатраты = СтрокаТрудозатрат.ТребуемоеВремяВыполнения; // В минутах
    КонецЦикла;
    
КонецПроцедуры

&НаСервере
Функция ПолучитьЦенуМатериалаИзЗакупок(Материал)
    // Ищем последнюю закупку этого материала
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ ПЕРВЫЕ 1
    |   Поступление.Цена КАК Цена
    |ИЗ
    |   Документ.Закупка.Закупка КАК Поступление
    |ГДЕ
    |   Поступление.Материал = &Материал
    |   И Поступление.Цена > 0
    |
    |УПОРЯДОЧИТЬ ПО
    |   Поступление.Ссылка.Дата УБЫВ";
    
    Запрос.УстановитьПараметр("Материал", Материал);
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    Если Выборка.Следующий() Тогда
        Возврат Выборка.Цена;
    КонецЕсли;
    
    // Если не нашли, возвращаем 0
    Возврат 0;
КонецФункции