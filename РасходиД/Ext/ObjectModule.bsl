Процедура ОбработкаПроведения(Отказ, Режим)
	
	// Очищаем движения
	Движения.РасчетСебестоимости.Записывать = Истина;
	Движения.РасчетСебестоимости.Очистить();
	
	// Движения по материалам (табличная часть "Себестоимость")
	Для Каждого ТекСтрокаМатериалы Из Себестоимость Цикл
		Движение = Движения.РасчетСебестоимости.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		Движение.Период = Дата;
		Движение.Материалы = ТекСтрокаМатериалы.Материал;
		Движение.Номенклатура = Номенклатура; // Готовая продукция
		Движение.Сумма = ТекСтрокаМатериалы.Сумма;
	КонецЦикла;
	
	// Движения по трудозатратам (табличная часть "Труды")
	Для Каждого ТекСтрокаТруды Из Труды Цикл
		
		// Получаем стоимость часа (БЕЗ ЗАПРОСА)
		СтоимостьЧаса = 0;
		Если ЗначениеЗаполнено(ТекСтрокаТруды.ВидРаботы) Тогда
			// Получаем объект справочника напрямую
			ОбъектСтоимость = ТекСтрокаТруды.ВидРаботы.ПолучитьОбъект();
			Если ОбъектСтоимость <> Неопределено Тогда
				СтоимостьЧаса = ОбъектСтоимость.СтоимостьЧаса;
			КонецЕсли;
		КонецЕсли;
		
		// Рассчитываем сумму трудозатрат (минуты / 60 * стоимость часа)
		СуммаТрудозатрат = (ТекСтрокаТруды.Трудозатраты / 60) * СтоимостьЧаса;
		
		// Создаем движение
		Движение = Движения.РасчетСебестоимости.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		Движение.Период = Дата;
		Движение.Трудозатраты = ТекСтрокаТруды.ВидРаботы;
		Движение.Номенклатура = Номенклатура; // Готовая продукция
		Движение.ТрудозатратыСумма = СуммаТрудозатрат;
		
	КонецЦикла;
	
КонецПроцедуры