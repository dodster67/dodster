&НаКлиенте
Процедура СделатьФото(Команда)
	
	#Если МобильноеПриложениеКлиент Тогда
		
		Попытка
			// Проверяем, поддерживается ли камера
			Если СредстваМультимедиа.ПоддерживаетсяФотоснимок() Тогда
				
				// Делаем снимок
				ДанныеМультимедиа = СредстваМультимедиа.СделатьФотоснимок();
				
				Если ДанныеМультимедиа <> Неопределено Тогда
					
					// Получаем двоичные данные снимка
					ДвоичныеДанныеФото = ДанныеМультимедиа.ПолучитьДвоичныеДанные();
					
					// Помещаем во временное хранилище
					Адрес = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФото, ЭтаФорма.УникальныйИдентификатор);
					
					// Создаем новую строку в таблице фотографий
					НоваяСтрока = Объект.ФотоБрака.Добавить();
					
					// Сохраняем адрес временного хранилища
					НоваяСтрока.АдресФото = Адрес;
					НоваяСтрока.Комментарий = "Фото брака от " + Формат(ТекущаяДата(), "ДЛФ=ДД.ММ.ГГГГ ЧЧ:ММ:СС");
					
					// Обновляем отображение таблицы
					Элементы.ФотоБрака.Обновить();
					
				КонецЕсли;
				
			Иначе
				Сообщить("Камера не поддерживается на этом устройстве");
			КонецЕсли;
			
		Исключение
			Сообщить("Ошибка при съемке: " + ОписаниеОшибки());
		КонецПопытки;
		
	#КонецЕсли
	
КонецПроцедуры

&НаКлиенте
Процедура ВыбратьИзГалереи(Команда)
	
	// Открываем диалог выбора файлов
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Диалог.Фильтр = "Изображения (*.jpg, *.jpeg, *.png)|*.jpg;*.jpeg;*.png";
	Диалог.МножественныйВыбор = Ложь;
	Диалог.Заголовок = "Выберите фото брака";
	
	Если Диалог.Выбрать() Тогда
		
		Попытка
			// Читаем файл
			Файл = Новый ДвоичныеДанные(Диалог.ПолноеИмяФайла);
			
			// Помещаем во временное хранилище
			Адрес = ПоместитьВоВременноеХранилище(Файл, ЭтаФорма.УникальныйИдентификатор);
			
			// Получаем имя файла без пути
			ПолноеИмя = Диалог.ПолноеИмяФайла;
			Позиция = СтрНайти(ПолноеИмя, "\", НаправлениеПоиска.СКонца);
			Если Позиция = 0 Тогда
				Позиция = СтрНайти(ПолноеИмя, "/", НаправлениеПоиска.СКонца);
			КонецЕсли;
			
			Если Позиция > 0 Тогда
				ИмяФайла = Сред(ПолноеИмя, Позиция + 1);
			Иначе
				ИмяФайла = ПолноеИмя;
			КонецЕсли;
			
			// Убираем расширение
			Точка = СтрНайти(ИмяФайла, ".", НаправлениеПоиска.СКонца);
			Если Точка > 0 Тогда
				ИмяБезРасширения = Лев(ИмяФайла, Точка - 1);
			Иначе
				ИмяБезРасширения = ИмяФайла;
			КонецЕсли;
			
			// Добавляем строку
			НоваяСтрока = Объект.ФотоБрака.Добавить();
			НоваяСтрока.АдресФото = Адрес;
			НоваяСтрока.Комментарий = ИмяБезРасширения;
			
			// Обновляем отображение таблицы
			Элементы.ФотоБрака.Обновить();
			
		Исключение
			Сообщить("Ошибка при загрузке фото: " + ОписаниеОшибки());
		КонецПопытки;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура УдалитьФото(Команда)
	
	// Получаем текущую строку в таблице
	ТекущаяСтрока = Элементы.ФотоБрака.ТекущиеДанные;
	
	Если ТекущаяСтрока = Неопределено Тогда
		Сообщить("Выберите фото для удаления");
		Возврат;
	КонецЕсли;
	
	// Удаляем строку
	Объект.ФотоБрака.Удалить(ТекущаяСтрока);
	
	// Обновляем отображение
	
КонецПроцедуры

&НаСервере
Процедура ОтправитьНаСервер()
	
	// Проверка заполнения обязательных полей
	Если Не ЗначениеЗаполнено(Объект.Изделие) Тогда
		Сообщить("Заполните изделие");
		Возврат;
	КонецЕсли;
	
	Если Объект.КоличествоБрака <= 0 Тогда
		Сообщить("Укажите количество брака");
		Возврат;
	КонецЕсли;
	
	// Подготовка данных для отправки
	ДанныеДляОтправки = Новый Структура;
	
	// Дата
	ДанныеДляОтправки.Вставить("Дата", Строка(Объект.Дата));
	
	// Этап производства (передаем номер)
	Если ЗначениеЗаполнено(Объект.ЭтапПроизводства) Тогда
		ДанныеДляОтправки.Вставить("ЭтапПроизводства", Объект.ЭтапПроизводства.Номер);
	Иначе
		ДанныеДляОтправки.Вставить("ЭтапПроизводства", "");
	КонецЕсли;
	
	// Изделие (передаем код)
	Если ЗначениеЗаполнено(Объект.Изделие) Тогда
		ДанныеДляОтправки.Вставить("Изделие", Объект.Изделие.Код);
	Иначе
		ДанныеДляОтправки.Вставить("Изделие", "");
	КонецЕсли;
	
	// Количество
	ДанныеДляОтправки.Вставить("КоличествоБрака", Строка(Объект.КоличествоБрака));
	
	// Причина
	ДанныеДляОтправки.Вставить("Причина", Объект.ПричинаБрака);
	
	// Бригада (передаем код)
	Если ЗначениеЗаполнено(Объект.Бригада) Тогда
		ДанныеДляОтправки.Вставить("Бригада", Объект.Бригада.Код);
	Иначе
		ДанныеДляОтправки.Вставить("Бригада", "");
	КонецЕсли;
	
	// Подготовка фотографий (конвертируем в Base64)
	// Подготовка фотографий (только комментарии)
	// Подготовка фотографий
	МассивФото = Новый Массив;
	
	Для Каждого СтрокаФото Из Объект.ФотоБрака Цикл
		
		СтруктураФото = Новый Структура;
		СтруктураФото.Вставить("Данные", "");
		СтруктураФото.Вставить("Комментарий", Строка(СтрокаФото.Комментарий));
		
		МассивФото.Добавить(СтруктураФото);
	КонецЦикла;
	
	ДанныеДляОтправки.Вставить("Фото", МассивФото);
	
	// Преобразуем в JSON
	JSON = ЗаписатьЗначениеJSON(ДанныеДляОтправки);
	
	
	// Отправка на сервер
	АдресСервера = "192.168.0.150:8080";
	СтрокаЗапроса = "/WEB/hs/services/brak";
	
	Попытка
		Соединение = Новый HTTPСоединение(АдресСервера);
		ЗапросHTTP = Новый HTTPЗапрос(СтрокаЗапроса);
		//ЗапросHTTP.Метод = "PUT";
		//ЗапросHTTP.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
		ЗапросHTTP.УстановитьТелоИзСтроки(JSON);
		
		Ответ = Соединение.Записать(ЗапросHTTP);
		
		Если Ответ.КодСостояния = 200 Тогда
			Сообщить("Акт о браке успешно отправлен на сервер");
			
			// Записываем документ в мобильной базе
			
			// Закрываем форму
			//ЭтаФорма.Закрыть();
			
		Иначе
			ТекстОшибки = Ответ.ПолучитьТелоКакСтроку();
			Сообщить("Ошибка на сервере: " + ТекстОшибки);
		КонецЕсли;
		
	Исключение
		Сообщить("Ошибка соединения: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура Отправить(Команда)
	ОтправитьНаСервер();
КонецПроцедуры