// Модуль формы обработки ГенераторДанныхИзделий

&НаКлиенте
Перем ВременныеДанные; // Здесь будем хранить сгенерированные данные

&НаКлиенте
Процедура ПриОткрытии(Отказ)
    ВременныеДанные = Новый Массив;
    // Устанавливаем значения по умолчанию
    Объект.КоличествоИзделий = 10;
    Объект.ВидПроизводства = "Мебель";
    Объект.МинКоличествоМатериалов = 4;
    Объект.МаксКоличествоМатериалов = 8;
КонецПроцедуры

&НаКлиенте
Процедура Сгенерировать(Команда)
    // Проверка ввода
    Если Объект.КоличествоИзделий <= 0 ИЛИ Объект.КоличествоИзделий > 100 Тогда
        Сообщить("Количество изделий должно быть от 1 до 100");
        Возврат;
    КонецЕсли;
    
    Если ПустаяСтрока(Объект.ВидПроизводства) Тогда
        Сообщить("Укажите вид производства");
        Возврат;
    КонецЕсли;
    
    Попытка
        // Очищаем временные данные
        ВременныеДанные = Новый Массив;
        
        // Генерируем изделия и ПОЛУЧАЕМ результат обратно
        ВременныеДанные = СгенерироватьИзделияНаСервере(Объект.КоличествоИзделий, Объект.ВидПроизводства);
        
        // Проверяем, что получили данные
        Если ВременныеДанные = Неопределено ИЛИ ВременныеДанные.Количество() = 0 Тогда
            Сообщить("Ошибка: Не удалось получить данные от сервера");
            Возврат;
        КонецЕсли;
        
        Сообщить("Получены данные от сервера: " + ВременныеДанные.Количество() + " изделий");
        
        // Обновляем таблицу предпросмотра
        ОбновитьТаблицуПредпросмотра();
        
        Сообщить("Сгенерировано " + Объект.КоличествоИзделий + " изделий");
    Исключение
        Сообщить("Ошибка при генерации: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

&НаСервере
Функция СгенерироватьИзделияНаСервере(Количество, ВидПроизводства)
    
    // Формируем промпт для ИИ
    Промпт = СтрШаблон("
        |Сгенерируй %1 уникальных наименований изделий для производства типа '%2'.
        |
        |Требования:
        |1. Названия должны быть реалистичными и разнообразными
        |2. Артикулы ДОЛЖНЫ БЫТЬ ПОСЛЕДОВАТЕЛЬНЫМИ числами от 1 до %1 (1, 2, 3, 4, 5...)
        |3. Выбери единицу измерения ИЗ СПИСКА: шт, кг, л, комплект
        |4. Выбирай единицу измерения логично: 
        |   - Для штучных товаров (ложки, тарелки, чашки) используй 'шт'
        |   - Для сыпучих (фрукты, ягоды) используй 'кг'  
        |   - Для жидкостей (сок, вода) используй 'л'
        |
        |ВАЖНО: Верни ответ строго в формате JSON массива объектов.
        |Формат каждого объекта: {
        |   'Наименование': 'название изделия',
        |   'Артикул': число,
        |   'ЕдиницаИзмерения': 'единица'
        |}
        |
        |Пример правильного ответа для 3 изделий: [
        |   {'Наименование': 'Яблоки свежие', 'Артикул': 1, 'ЕдиницаИзмерения': 'кг'},
        |   {'Наименование': 'Ложка столовая', 'Артикул': 2, 'ЕдиницаИзмерения': 'шт'},
        |   {'Наименование': 'Сок яблочный', 'Артикул': 3, 'ЕдиницаИзмерения': 'л'}
        |]
        |", Количество, ВидПроизводства);
    
    // Отправляем запрос к ИИ
    Ответ = ИИКлиентСервер.ОтправитьЗапросИИ(Промпт);
    
    Если Ответ = Неопределено Тогда
        ВызватьИсключение("Не удалось получить ответ от ИИ");
    КонецЕсли;
    
    // Очищаем JSON от возможной разметки
    Ответ = ИИКлиентСервер.ОчиститьJSON(Ответ);
    
    // Парсим JSON ответ
    Попытка
        ЧтениеJSON = Новый ЧтениеJSON;
        ЧтениеJSON.УстановитьСтроку(Ответ);
        МассивИзделий = ПрочитатьJSON(ЧтениеJSON);
        
        // Проверяем, что получили массив
        Если ТипЗнч(МассивИзделий) <> Тип("Массив") Тогда
            ВызватьИсключение("ИИ вернул не массив данных");
        КонецЕсли;
        
        Сообщить("Получено изделий от ИИ: " + МассивИзделий.Количество());
        
        // Выводим каждое изделие для отладки
        Для Индекс = 0 По МассивИзделий.Количество() - 1 Цикл
            Сообщить("Изделие " + Индекс + ": " + МассивИзделий[Индекс].Наименование);
        КонецЦикла;
        
        // Возвращаем массив изделий
        Возврат МассивИзделий;
        
    Исключение
        ВызватьИсключение("Ошибка при обработке ответа от ИИ: " + ОписаниеОшибки());
	КонецПопытки;
	
	
КонецФункции

&НаКлиенте
Процедура ОбновитьТаблицуПредпросмотра()
    // Очищаем таблицу
    Объект.ТЧПредпросмотр.Очистить();
    
    // Проверяем, есть ли временные данные
    Если ВременныеДанные = Неопределено ИЛИ ВременныеДанные.Количество() = 0 Тогда
        Сообщить("Нет данных для отображения");
        Возврат;
    КонецЕсли;
    
    // Заполняем из временных данных
    Для Каждого Изделие Из ВременныеДанные Цикл
        НоваяСтрока = Объект.ТЧПредпросмотр.Добавить();
        НоваяСтрока.Наименование = Изделие.Наименование;
        НоваяСтрока.Артикул = Строка(Изделие.Артикул);
        НоваяСтрока.ЕдиницаИзмерения = Изделие.ЕдиницаИзмерения;
        
        // Добавляем отображение типа
        НоваяСтрока.ТипНоменклатуры = "Готовая продукция";
    КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура СохранитьВБазу(Команда)
    Если Объект.ТЧПредпросмотр.Количество() = 0 Тогда
        Сообщить("Нет данных для сохранения");
        Возврат;
    КонецЕсли;
    
    // Используем не-модальный вопрос
    Оповещение = Новый ОписаниеОповещения("ПослеПодтвержденияСохранения", ЭтотОбъект);
    ПоказатьВопрос(Оповещение, "Сохранить сгенерированные изделия в справочник Номенклатура?", 
                    РежимДиалогаВопрос.ДаНет);
КонецПроцедуры

&НаКлиенте
Процедура ПослеПодтвержденияСохранения(Результат, Параметры) Экспорт
    Если Результат <> КодВозвратаДиалога.Да Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        СохранитьИзделияНаСервере();
        Сообщить("Данные успешно сохранены");
    Исключение
        Сообщить("Ошибка при сохранении: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

&НаСервере
Процедура СохранитьИзделияНаСервере()
    // Получаем данные из табличной части
    ТЧ = Объект.ТЧПредпросмотр.Выгрузить();
    
    Для Каждого Строка Из ТЧ Цикл
        // Проверяем, есть ли уже такой код
        Найденный = Справочники.Номенклатура.НайтиПоКоду(Строка.Артикул);
        
        Если Найденный.Пустая() Тогда
            // Создаем новый элемент
            НовыйЭлемент = Справочники.Номенклатура.СоздатьЭлемент();
            НовыйЭлемент.Наименование = Строка.Наименование;
            НовыйЭлемент.Код = Строка.Артикул; // Заполняем КОД, а не Артикул!
            
            // Заполняем единицу измерения
            Попытка
                НовыйЭлемент.Единица_измерения = ПолучитьЕдиницуИзмерения(Строка.ЕдиницаИзмерения);
            Исключение
                // Если реквизита нет - игнорируем
            КонецПопытки;
            
            // Устанавливаем тип "Готовая продукция"
            Попытка
                НовыйЭлемент.Тип = Перечисления.Тип.Готовая_продукция;
            Исключение
                // Если реквизита нет - игнорируем
            КонецПопытки;
            
            Попытка
                НовыйЭлемент.Записать();
                Сообщить("Сохранено: " + Строка.Наименование + " (Код: " + Строка.Артикул + ")");
            Исключение
                Сообщить("Ошибка при записи: " + ОписаниеОшибки());
            КонецПопытки;
        Иначе
            Сообщить("Изделие с кодом " + Строка.Артикул + " уже существует");
        КонецЕсли;
    КонецЦикла;
КонецПроцедуры

&НаСервере
Функция ПолучитьЕдиницуИзмерения(Знач КодЕдиницы)
    КодЕдиницы = СокрЛП(КодЕдиницы);
    
    // Значение по умолчанию
    ЕдПоУмолчанию = Перечисления.Единица_измерения.кг;
    
    // Сопоставление кодов с перечислением
    Если КодЕдиницы = "шт" ИЛИ КодЕдиницы = "штука" ИЛИ КодЕдиницы = "штуки" Тогда
        Попытка
            Возврат Перечисления.Единица_измерения.шт;
        Исключение
            Возврат ЕдПоУмолчанию;
        КонецПопытки;
        
    ИначеЕсли КодЕдиницы = "кг" ИЛИ КодЕдиницы = "килограмм" Тогда
        Возврат Перечисления.Единица_измерения.кг;
        
    ИначеЕсли КодЕдиницы = "л" ИЛИ КодЕдиницы = "литр" ИЛИ КодЕдиницы = "литры" Тогда
        Попытка
            Возврат Перечисления.Единица_измерения.Литры;
        Исключение
            Попытка
                Возврат Перечисления.Единица_измерения.л;
            Исключение
                Возврат ЕдПоУмолчанию;
            КонецПопытки;
        КонецПопытки;
        
    ИначеЕсли КодЕдиницы = "комплект" Тогда
        Попытка
            Возврат Перечисления.Единица_измерения.комплект;
        Исключение
            Возврат ЕдПоУмолчанию;
        КонецПопытки;
    КонецЕсли;
    
    // По умолчанию - кг
    Возврат ЕдПоУмолчанию;
КонецФункции

&НаКлиенте
Процедура СформироватьСпецификации(Команда)
    Если Объект.МинКоличествоМатериалов <= 0 ИЛИ Объект.МаксКоличествоМатериалов <= 0 Тогда
        Сообщить("Укажите корректный диапазон количества материалов");
        Возврат;
    КонецЕсли;
    
    Если Объект.МинКоличествоМатериалов > Объект.МаксКоличествоМатериалов Тогда
        Сообщить("Минимальное количество не может быть больше максимального");
        Возврат;
    КонецЕсли;
    
	Попытка
	    СформироватьСпецификацииНаСервере(Объект.МинКоличествоМатериалов, Объект.МаксКоличествоМатериалов);
	Исключение
	    Сообщить("Ошибка: " + ОписаниеОшибки());
	КонецПопытки;
КонецПроцедуры

&НаСервере
Процедура СформироватьСпецификацииНаСервере(МинКол, МаксКол)
    // Получаем все изделия с типом "Готовая продукция"
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |   Номенклатура.Ссылка КАК Изделие,
    |   Номенклатура.Наименование КАК Наименование,
    |   Номенклатура.Единица_измерения КАК ЕдиницаИзмерения
    |ИЗ
    |   Справочник.Номенклатура КАК Номенклатура
    |ГДЕ
    |   Номенклатура.Тип = &ТипГотоваяПродукция
    |   И НЕ Номенклатура.ПометкаУдаления";
    
    Запрос.УстановитьПараметр("ТипГотоваяПродукция", Перечисления.Тип.Готовая_продукция);
    
    Результат = Запрос.Выполнить();
    
    // Получаем количество записей
    ВыборкаДляСчета = Результат.Выбрать();
    ВсегоИзделий = 0;
    Пока ВыборкаДляСчета.Следующий() Цикл
        ВсегоИзделий = ВсегоИзделий + 1;
    КонецЦикла;
    
    Если ВсегоИзделий = 0 Тогда
        Сообщить("Нет готовой продукции для создания спецификаций");
        Возврат;
    КонецЕсли;
    
    Сообщить("Найдено изделий для создания спецификаций: " + ВсегоИзделий);
    
    // Теперь обрабатываем каждое изделие
    Выборка = Результат.Выбрать();
    Счетчик = 0;
    
    Пока Выборка.Следующий() Цикл
        Счетчик = Счетчик + 1;
        
        // Формируем промпт для создания спецификации
        Промпт = СтрШаблон("
            |Создай спецификацию для производства изделия '%1'.
            |
            |Требования к спецификации:
			|1. Используй от %2 до %3 различных материалов
			// Замените в промпте раздел про материалы:
			|2. Для материалов используй реалистичные названия
			|   - Сырье: дерево, металл, пластик, ткань и т.д.
			|   - Полуфабрикаты: заготовки, смеси, концентраты, растворы и т.д.
			|3. Укажи количество каждого материала (целое положительное число от 1 до 5)
			|4. Укажи единицу измерения для каждого материала (кг, шт, л, комплект)
			|   - Для жидкостей используй 'л'
			|   - Для штучных материалов используй 'шт'
			|   - Для сыпучих используй 'кг'
			|   - Для наборов используй 'комплект'
			|5. Добавь 2-4 вида работ с трудозатратами (в минутах, от 5 до 120 минут)
			|6. Для каждого вида работ придумай стоимость часа (целое число, например: 500, 1000, 1500)
            |
            |ВАЖНО: Верни результат строго в формате JSON.
            |
            |Формат ответа:
            |{
            |   'Материалы': [
            |       {'Наименование': 'название материала', 'Количество': число, 'ЕдиницаИзмерения': 'ед'},
            |       ...
            |   ],
            |   'Трудозатраты': [
            |       {'ВидРабот': 'название работы', 'ВремяВМинутах': число, 'СтоимостьЧаса': число},
            |       ...
            |   ]
            |}
            |
            |Пример для стула:
            |{
            |   'Материалы': [
            |       {'Наименование': 'Доска дубовая', 'Количество': 2, 'ЕдиницаИзмерения': 'шт'},
            |       {'Наименование': 'Саморезы', 'Количество': 16, 'ЕдиницаИзмерения': 'шт'},
            |       {'Наименование': 'Лак мебельный', 'Количество': 0.5, 'ЕдиницаИзмерения': 'л'}
            |   ],
            |   'Трудозатраты': [
            |       {'ВидРабот': 'Распил деталей', 'ВремяВМинутах': 30, 'СтоимостьЧаса': 800},
            |       {'ВидРабот': 'Сборка', 'ВремяВМинутах': 45, 'СтоимостьЧаса': 1000},
            |       {'ВидРабот': 'Покраска', 'ВремяВМинутах': 25, 'СтоимостьЧаса': 900}
            |   ]
            |}
            |", Выборка.Наименование, МинКол, МаксКол);
        
        // Отправляем запрос к ИИ
        Ответ = ИИКлиентСервер.ОтправитьЗапросИИ(Промпт);
        
        Если Ответ <> Неопределено Тогда
            СоздатьИЗаписатьСпецификацию(Выборка.Изделие, Выборка.ЕдиницаИзмерения, Ответ);
        Иначе
            Сообщить("Не удалось получить ответ от ИИ для " + Выборка.Наименование);
        КонецЕсли;
        
    КонецЦикла;
    
    Сообщить("Формирование спецификаций завершено");
КонецПроцедуры

&НаСервере
Функция ПолучитьСуществующиеМатериалы()
    // Получаем все материалы (сырье и полуфабрикаты)
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |   Номенклатура.Наименование КАК Наименование
    |ИЗ
    |   Справочник.Номенклатура КАК Номенклатура
    |ГДЕ
    |   (Номенклатура.Тип = &ТипСырье ИЛИ Номенклатура.Тип = &ТипПолуфабрикат)
    |   И НЕ Номенклатура.ПометкаУдаления
    |
    |УПОРЯДОЧИТЬ ПО
    |   Наименование";
    
    Запрос.УстановитьПараметр("ТипСырье", Перечисления.Тип.Сырье);
    Запрос.УстановитьПараметр("ТипПолуфабрикат", Перечисления.Тип.Полуфабрикат);
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    Материалы = Новый Массив;
    Пока Выборка.Следующий() Цикл
        Материалы.Добавить(Выборка.Наименование);
    КонецЦикла;
    
    Возврат Материалы;
КонецФункции

&НаСервере
Процедура СоздатьИЗаписатьСпецификацию(Изделие, ЕдиницаИзмеренияИзделия, ДанныеJSON)
    Попытка
        // Очищаем JSON
        ДанныеJSON = ИИКлиентСервер.ОчиститьJSON(ДанныеJSON);
        
        ЧтениеJSON = Новый ЧтениеJSON;
        ЧтениеJSON.УстановитьСтроку(ДанныеJSON);
        СтруктураСпецификации = ПрочитатьJSON(ЧтениеJSON);
        
        // Проверяем структуру
        Если СтруктураСпецификации.Свойство("Материалы") = Ложь Тогда
            ВызватьИсключение("В ответе нет раздела 'Материалы'");
        КонецЕсли;
        
        Если СтруктураСпецификации.Свойство("Трудозатраты") = Ложь Тогда
            ВызватьИсключение("В ответе нет раздела 'Трудозатраты'");
        КонецЕсли;
        
        // Создаем новую спецификацию
        Спецификация = Справочники.Спецификации.СоздатьЭлемент();
        
        // Убираем запись в Наименование - его нет в справочнике!
        // Код сгенерируется автоматически
        
        // Выходное изделие
        Спецификация.Выходное_изделие = Изделие;
        
        // Количество (по стандарту = 1)
        Спецификация.Количество = 1;
        
        // Единица измерения (берем из изделия)
        Попытка
            Спецификация.Единица_измерения = ЕдиницаИзмеренияИзделия;
        Исключение
            // Если нет - оставляем пустым
        КонецПопытки;
        
        // Статус - Архивный (для проверки человеком)
        Попытка
            // Ищем значение "Архивная" в перечислении Статус
            Спецификация.Статус = Перечисления.Статус.Архивная;
        Исключение
            // Если нет - оставляем пустым
            Сообщить("Не удалось установить статус 'Архивная' для спецификации");
        КонецПопытки;
        
        // Заполняем материалы
        Материалы = СтруктураСпецификации.Материалы;
        Для Каждого Материал Из Материалы Цикл
            НоваяСтрока = Спецификация.Материалы.Добавить();
            
            // Находим или создаем материал
            СсылкаНаМатериал = НайтиИлиСоздатьМатериал(Материал.Наименование);
            НоваяСтрока.Материал = СсылкаНаМатериал;
            
            // Заполняем количество (от 1 до 5)
            Попытка
                Количество = Число(Материал.Количество);
                Если Количество < 1 Тогда Количество = 1; КонецЕсли;
                Если Количество > 5 Тогда Количество = 5; КонецЕсли;
                НоваяСтрока.Количество = Количество;
            Исключение
                НоваяСтрока.Количество = 1;
            КонецПопытки;
            
            // Заполняем единицу измерения
            Если ЗначениеЗаполнено(Материал.ЕдиницаИзмерения) Тогда
                Попытка
                    НоваяСтрока.Единица_Измерения = ПолучитьЕдиницуИзмерения(Материал.ЕдиницаИзмерения);
                Исключение
                    // Игнорируем
                КонецПопытки;
            КонецЕсли;
            
            // Этап - по умолчанию "Завершен" из справочника Этапы
            Попытка
                НоваяСтрока.Этап = ПолучитьЭтапПоНаименованию("Завершен");
            Исключение
                // Игнорируем
            КонецПопытки;
            
            // Спецификацию оставляем пустой
        КонецЦикла;
        
        // Заполняем трудозатраты
        Трудозатраты = СтруктураСпецификации.Трудозатраты;
        Для Каждого Трудозатрата Из Трудозатраты Цикл
            НоваяСтрока = Спецификация.ТрудозатратыПоЭтапам.Добавить();
            
            // Получаем или создаем вид работы в справочнике СтоимостьЧаса
            ВидРаботыСсылка = НайтиИлиСоздатьВидРаботы(
                Трудозатрата.ВидРабот, 
                Трудозатрата.СтоимостьЧаса
            );
            
            НоваяСтрока.ВидРабот = ВидРаботыСсылка;
            
            // Заполняем время выполнения в минутах
            Попытка
                ВремяВМинутах = Число(Трудозатрата.ВремяВМинутах);
                Если ВремяВМинутах < 5 Тогда ВремяВМинутах = 5; КонецЕсли;
                Если ВремяВМинутах > 120 Тогда ВремяВМинутах = 120; КонецЕсли;
                НоваяСтрока.ТребуемоеВремяВыполнения = ВремяВМинутах;
            Исключение
                НоваяСтрока.ТребуемоеВремяВыполнения = 60; // По умолчанию 1 час
            КонецПопытки;
        КонецЦикла;
        
        // Записываем спецификацию
        Спецификация.Записать();
        Сообщить("Создана спецификация для " + Изделие.Наименование);
        
    Исключение
        Сообщить("Ошибка при создании спецификации для " + Изделие.Наименование + ": " + ОписаниеОшибки());
        ЗаписьЖурналаРегистрации("ИИ-Ассистент", УровеньЖурналаРегистрации.Ошибка,,,
            "Ошибка создания спецификации: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

&НаСервере
Функция НайтиИлиСоздатьМатериал(Знач НаименованиеМатериала)
    // Очищаем наименование
    НаименованиеМатериала = СокрЛП(НаименованиеМатериала);
    
    Если ПустаяСтрока(НаименованиеМатериала) Тогда
        Возврат Справочники.Номенклатура.ПустаяСсылка();
    КонецЕсли;
    
    // Пытаемся найти существующий материал по наименованию
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ ПЕРВЫЕ 1
    |   Номенклатура.Ссылка
    |ИЗ
    |   Справочник.Номенклатура КАК Номенклатура
    |ГДЕ
    |   Номенклатура.Наименование = &Наименование
    |   И НЕ Номенклатура.ПометкаУдаления";
    
    Запрос.УстановитьПараметр("Наименование", НаименованиеМатериала);
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    Если Выборка.Следующий() Тогда
        Возврат Выборка.Ссылка;
    КонецЕсли;
    
    // Если не нашли, создаем новый
    НовыйМатериал = Справочники.Номенклатура.СоздатьЭлемент();
    НовыйМатериал.Наименование = НаименованиеМатериала;
    
    // Генерируем код
    ТекДата = ТекущаяДата();
    НовыйМатериал.Код = "МАТ" + Формат(ТекДата, "ДФ=ddMMyyyyhhmmss");
    
    // Логически определяем тип материала (Сырье или Полуфабрикат)
    ТипМатериала = ОпределитьТипМатериала(НаименованиеМатериала);
    Попытка
        НовыйМатериал.Тип = ТипМатериала;
    Исключение
        // Если нет перечисления - игнорируем
    КонецПопытки;
    
    // Логически определяем единицу измерения
    ЕдиницаИзмерения = ОпределитьЕдиницуИзмеренияМатериала(НаименованиеМатериала);
    Попытка
        НовыйМатериал.Единица_измерения = ЕдиницаИзмерения;
    Исключение
        // Если нет - игнорируем
    КонецПопытки;
    
    Попытка
        НовыйМатериал.Записать();
        Сообщить("Создан новый материал: " + НаименованиеМатериала + 
                 " (Код: " + НовыйМатериал.Код + 
                 ", Тип: " + ТипМатериала + 
                 ", Ед.изм: " + ЕдиницаИзмерения + ")");
    Исключение
        Сообщить("Ошибка при создании материала: " + ОписаниеОшибки());
        Возврат Справочники.Номенклатура.ПустаяСсылка();
    КонецПопытки;
    
    Возврат НовыйМатериал.Ссылка;
КонецФункции

&НаСервере
Функция ОпределитьТипМатериала(Знач Наименование)
    НаименованиеНиз = ВРег(Наименование);
    
    // Список ключевых слов для полуфабрикатов
    Полуфабрикаты = Новый Массив;
    Полуфабрикаты.Добавить("ТЕСТО");
    Полуфабрикаты.Добавить("ЗАГОТОВКА");
    Полуфабрикаты.Добавить("ПОЛУФАБРИКАТ");
    Полуфабрикаты.Добавить("СМЕСЬ");
    Полуфабрикаты.Добавить("РАСТВОР");
    Полуфабрикаты.Добавить("КОНЦЕНТРАТ");
    Полуфабрикаты.Добавить("ПОРОШОК");
    Полуфабрикаты.Добавить("ГРАНУЛЫ");
    Полуфабрикаты.Добавить("ПЛЕНКА");
    Полуфабрикаты.Добавить("ЛИСТ");
    Полуфабрикаты.Добавить("ПРОФИЛЬ");
    
    // Проверяем, является ли материал полуфабрикатом
    Для Каждого Ключ Из Полуфабрикаты Цикл
        Если Найти(НаименованиеНиз, Ключ) > 0 Тогда
            Возврат Перечисления.Тип.Полуфабрикат;
        КонецЕсли;
    КонецЦикла;
    
    // По умолчанию - сырье
    Возврат Перечисления.Тип.Сырье;
КонецФункции

&НаСервере
Функция ОпределитьЕдиницуИзмеренияМатериала(Знач Наименование)
    НаименованиеНиз = ВРег(Наименование);
    
    // Сначала проверим, какие значения вообще есть в перечислении
    // Для этого получим первую попавшуюся единицу измерения как "по умолчанию"
    ЕдПоУмолчанию = Перечисления.Единица_измерения.кг;
    
    // Логика для жидкостей
    Жидкости = Новый Массив;
    Жидкости.Добавить("ВОДА");
    Жидкости.Добавить("МОЛОКО");
    Жидкости.Добавить("МАСЛО");
    Жидкости.Добавить("СОК");
    Жидкости.Добавить("РАСТВОР");
    Жидкости.Добавить("КИСЛОТА");
    Жидкости.Добавить("ЩЕЛОЧЬ");
    Жидкости.Добавить("СМАЗКА");
    Жидкости.Добавить("КЛЕЙ");
    Жидкости.Добавить("ЛАК");
    Жидкости.Добавить("КРАСКА");
    
    Для Каждого Ключ Из Жидкости Цикл
        Если Найти(НаименованиеНиз, Ключ) > 0 Тогда
            // Пробуем найти "Литры" или "л" в перечислении
            Попытка
                Возврат Перечисления.Единица_измерения.Литры;
            Исключение
                // Если нет "Литры", пробуем "л"
                Попытка
                    Возврат Перечисления.Единица_измерения.л;
                Исключение
                    // Если нет и "л", возвращаем кг
                    Возврат ЕдПоУмолчанию;
                КонецПопытки;
            КонецПопытки;
        КонецЕсли;
    КонецЦикла;
    
    // Логика для штучных материалов
    Штучные = Новый Массив;
    Штучные.Добавить("САМОРЕЗ");
    Штучные.Добавить("ГВОЗДЬ");
    Штучные.Добавить("БОЛТ");
    Штучные.Добавить("ГАЙКА");
    Штучные.Добавить("ШАЙБА");
    Штучные.Добавить("РУЧКА");
    Штучные.Добавить("ПЕТЛЯ");
    Штучные.Добавить("ЗАМОК");
    Штучные.Добавить("ДОСКА");
    Штучные.Добавить("БРУС");
    Штучные.Добавить("ЛИСТ");
    Штучные.Добавить("ПЛЕНКА");
    Штучные.Добавить("ПАКЕТ");
    Штучные.Добавить("КОРОБКА");
    
    Для Каждого Ключ Из Штучные Цикл
        Если Найти(НаименованиеНиз, Ключ) > 0 Тогда
            Попытка
                Возврат Перечисления.Единица_измерения.шт;
            Исключение
                // Если нет "шт", возвращаем кг
                Возврат ЕдПоУмолчанию;
            КонецПопытки;
        КонецЕсли;
    КонецЦикла;
    
    // Логика для комплектов
    Комплекты = Новый Массив;
    Комплекты.Добавить("КОМПЛЕКТ");
    Комплекты.Добавить("НАБОР");
    Комплекты.Добавить("СЕРВИЗ");
    
    Для Каждого Ключ Из Комплекты Цикл
        Если Найти(НаименованиеНиз, Ключ) > 0 Тогда
            Попытка
                Возврат Перечисления.Единица_измерения.комплект;
            Исключение
                Возврат ЕдПоУмолчанию;
            КонецПопытки;
        КонецЕсли;
    КонецЦикла;
    
    // По умолчанию - кг
    Возврат ЕдПоУмолчанию;
КонецФункции
//&НаСервере
//Функция НайтиИлиСоздатьВидРабот(Знач НаименованиеРаботы)
//    НаименованиеРаботы = СокрЛП(НаименованиеРаботы);
//    
//    Если ПустаяСтрока(НаименованиеРаботы) Тогда
//        Возврат Справочники.Этапы.ПустаяСсылка();
//    КонецЕсли;
//    
//    // Ищем существующий этап
//    Запрос = Новый Запрос;
//    Запрос.Текст = 
//    "ВЫБРАТЬ ПЕРВЫЕ 1
//    |   Этапы.Ссылка
//    |ИЗ
//    |   Справочник.Этапы КАК Этапы
//    |ГДЕ
//    |   Этапы.Наименование = &Наименование
//    |   И НЕ Этапы.ПометкаУдаления";
//    
//    Запрос.УстановитьПараметр("Наименование", НаименованиеРаботы);
//    
//    Результат = Запрос.Выполнить();
//    Выборка = Результат.Выбрать();
//    
//    Если Выборка.Следующий() Тогда
//        Возврат Выборка.Ссылка;
//    КонецЕсли;
//    
//    // Создаем новый этап
//    НовыйЭтап = Справочники.Этапы.СоздатьЭлемент();
//    НовыйЭтап.Наименование = НаименованиеРаботы;
//    
//    Попытка
//        НовыйЭтап.Записать();
//    Исключение
//        Сообщить("Ошибка при создании этапа: " + ОписаниеОшибки());
//        Возврат Справочники.Этапы.ПустаяСсылка();
//    КонецПопытки;
//    
//    Возврат НовыйЭтап.Ссылка;
//КонецФункции
&НаСервере
Функция НайтиИлиСоздатьВидРаботы(Знач НаименованиеРаботы, Знач СтоимостьЧаса)
    НаименованиеРаботы = СокрЛП(НаименованиеРаботы);
    
    Если ПустаяСтрока(НаименованиеРаботы) Тогда
        Возврат Справочники.СтоимостьЧаса.ПустаяСсылка();
    КонецЕсли;
    
    // Простой поиск по наименованию без запроса
    Найденный = Справочники.СтоимостьЧаса.НайтиПоНаименованию(НаименованиеРаботы);
    
    Если Не Найденный.Пустая() Тогда
        Возврат Найденный;
    КонецЕсли;
    
    // Если не нашли, создаем новый
    НовыйВидРаботы = Справочники.СтоимостьЧаса.СоздатьЭлемент();
    НовыйВидРаботы.Наименование = НаименованиеРаботы;
    
    // Устанавливаем стоимость часа
    Попытка
        Стоимость = Число(СтоимостьЧаса);
        Если Стоимость <= 0 Тогда Стоимость = 500; КонецЕсли;
        НовыйВидРаботы.СтоимостьЧаса = Стоимость;
    Исключение
        НовыйВидРаботы.СтоимостьЧаса = 500; // По умолчанию
    КонецПопытки;
    
    Попытка
        НовыйВидРаботы.Записать();
        Сообщить("Создан новый вид работ: " + НаименованиеРаботы + " (стоимость часа: " + НовыйВидРаботы.СтоимостьЧаса + ")");
    Исключение
        Сообщить("Ошибка при создании вида работ: " + ОписаниеОшибки());
        Возврат Справочники.СтоимостьЧаса.ПустаяСсылка();
    КонецПопытки;
    
    Возврат НовыйВидРаботы.Ссылка;
КонецФункции

&НаСервере
Функция ПолучитьЭтапПоНаименованию(Знач НаименованиеЭтапа)
    НаименованиеЭтапа = СокрЛП(НаименованиеЭтапа);
    
    Если ПустаяСтрока(НаименованиеЭтапа) Тогда
        Возврат Справочники.Этапы.ПустаяСсылка();
    КонецЕсли;
    
    // Ищем этап по наименованию
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ ПЕРВЫЕ 1
    |   Этапы.Ссылка
    |ИЗ
    |   Справочник.Этапы КАК Этапы
    |ГДЕ
    |   Этапы.Наименование = &Наименование
    |   И НЕ Этапы.ПометкаУдаления";
    
    Запрос.УстановитьПараметр("Наименование", НаименованиеЭтапа);
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    Если Выборка.Следующий() Тогда
        Возврат Выборка.Ссылка;
    КонецЕсли;
    
    // Если не нашли, возвращаем пустую ссылку
    Возврат Справочники.Этапы.ПустаяСсылка();
КонецФункции

