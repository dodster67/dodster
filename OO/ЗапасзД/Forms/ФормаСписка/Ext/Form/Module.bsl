&НаСервере
Функция ЗагрузитьДанныеНаСервере(СсылкаНаФайл)
	
	НовыйЗаказ = Документы.Заказ.СоздатьДокумент();
	НовыйЗаказ.Дата = ТекущаяДата();
	

	ТекстCSV = Новый ТекстовыйДокумент;
	Попытка
		ТекстCSV.Прочитать(СсылкаНаФайл, КодировкаТекста.UTF8);
	Исключение
		Попытка
			ТекстCSV.Прочитать(СсылкаНаФайл, КодировкаТекста.ANSI);
		Исключение
			Сообщить("Не удалось прочитать файл");
			Возврат Неопределено;
		КонецПопытки;
	КонецПопытки;
	
	КоличествоДобавленных = 0;
	КоличествоОшибок = 0;
	
	ПерваяСтрока = ТекстCSV.ПолучитьСтроку(1);
	Если СтрНайти(ПерваяСтрока, ";") > 0 Тогда
		Разделитель = ";";
	Иначе
		Разделитель = ",";
	КонецЕсли;
	
	Для НомерСтроки = 2 По ТекстCSV.КоличествоСтрок() Цикл
		
		СтрокаCSV = ТекстCSV.ПолучитьСтроку(НомерСтроки);
		Если ПустаяСтрока(СтрокаCSV) Тогда
			Продолжить;
		КонецЕсли;
		
		Колонки = СтрРазделить(СтрокаCSV, Разделитель, Ложь);
		
		Если Колонки.Количество() < 2 Тогда
			Сообщить("Строка " + НомерСтроки + ": недостаточно данных, пропущена");
			КоличествоОшибок = КоличествоОшибок + 1;
			Продолжить;
		КонецЕсли;
		
		Артикул = СокрЛП(Колонки[0]);
		КоличествоТекст = СокрЛП(Колонки[1]);
		
		Номенклатура = Справочники.Номенклатура.НайтиПоКоду(Артикул, Истина);
		
		Если Номенклатура = Справочники.Номенклатура.ПустаяСсылка() Тогда
			Номенклатура = Справочники.Номенклатура.НайтиПоНаименованию(Артикул, Истина);
		КонецЕсли;
		
		Если Номенклатура = Справочники.Номенклатура.ПустаяСсылка() Тогда
			Сообщить("Строка " + НомерСтроки + ": номенклатура с артикулом (кодом) '" + Артикул + "' не найдена");
			КоличествоОшибок = КоличествоОшибок + 1;
			Продолжить;
		КонецЕсли;
		

		Попытка
			Количество = Число(СтрЗаменить(КоличествоТекст, ",", "."));
		Исключение
			Сообщить("Строка " + НомерСтроки + ": неверный формат количества '" + КоличествоТекст + "'");
			КоличествоОшибок = КоличествоОшибок + 1;
			Продолжить;
		КонецПопытки;
		

		НоваяСтрока = НовыйЗаказ.СписокИзделий.Добавить();
		НоваяСтрока.Номенклатура = Номенклатура;
		НоваяСтрока.Количество = Количество;
		
		Если ЗначениеЗаполнено(Номенклатура.Единица_измерения) Тогда
			НоваяСтрока.ЕдиницаИзмерения = Номенклатура.Единица_измерения;
		КонецЕсли;
		
		Если Колонки.Количество() > 2 И ЗначениеЗаполнено(Колонки[2]) Тогда
			КодСпецификации = СокрЛП(Колонки[2]);
			Спецификация = Справочники.Спецификации.НайтиПоКоду(КодСпецификации, Истина);
			Если ЗначениеЗаполнено(Спецификация) Тогда
				НоваяСтрока.Спецификации = Спецификация;
			КонецЕсли;
		КонецЕсли;
		
		КоличествоДобавленных = КоличествоДобавленных + 1;
		
	КонецЦикла;
	
	Если КоличествоДобавленных > 0 Тогда
		Попытка
			НовыйЗаказ.Записать();
			Сообщить("Создан новый заказ №" + НовыйЗаказ.Номер);
			Сообщить("Добавлено позиций: " + КоличествоДобавленных);
			Если КоличествоОшибок > 0 Тогда
				Сообщить("Пропущено (ошибки): " + КоличествоОшибок);
			КонецЕсли;
			Возврат НовыйЗаказ.Ссылка;
		Исключение
			Сообщить("Ошибка при записи документа: " + ОписаниеОшибки());
			Возврат Неопределено;
		КонецПопытки;
	Иначе
		Сообщить("Нет позиций для создания заказа");
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

&НаКлиенте
Процедура ЗагрузитьДанные(Команда)
	
	ВыборФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ВыборФайла.МножественныйВыбор = Ложь;
	ВыборФайла.Фильтр = "CSV файлы (*.csv)|*.csv|Все файлы (*.*)|*.*";
	ВыборФайла.Заголовок = "Выберите CSV-файл для создания заказа";
	
	ВыборФайла.Показать(Новый ОписаниеОповещения("ПослеВыбораФайла", ЭтотОбъект));
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеВыбораФайла(Результат, ДопПараметр) Экспорт
	
	Если Результат = Неопределено Тогда
		Сообщить("Файл не выбран");
		Возврат;
	КонецЕсли;
	
	СсылкаНаФайл = Результат[0];
	
	СсылкаНаЗаказ = ЗагрузитьДанныеНаСервере(СсылкаНаФайл);
	
	Если ЗначениеЗаполнено(СсылкаНаЗаказ) Тогда
		ПараметрыФормы = Новый Структура;
		ПараметрыФормы.Вставить("Ключ", СсылкаНаЗаказ);
		ОткрытьФорму("Документ.Заказ.Форма.ФормаДокумента", ПараметрыФормы);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СформироватьЭтапы(Команда)
    // Получаем выделенные строки
    ВыделенныеСтроки = Элементы.Список.ВыделенныеСтроки;
    
    Если ВыделенныеСтроки.Количество() = 0 Тогда
        Сообщить("Выберите заказ из списка");
        Возврат;
    КонецЕсли;
    
    // Берем первую выделенную строку
    ТекущийЗаказСсылка = ВыделенныеСтроки[0];
    
    Если ТекущийЗаказСсылка = Неопределено ИЛИ ТекущийЗаказСсылка.Пустая() Тогда
        Сообщить("Выберите существующий заказ");
        Возврат;
    КонецЕсли;
    
    // Вызываем серверную процедуру
    СформироватьЭтапыНаСервере(ТекущийЗаказСсылка);
КонецПроцедуры

&НаСервере
Процедура СформироватьЭтапыНаСервере(Заказ)
    // Получаем объект заказа
    ЗаказОбъект = Заказ.ПолучитьОбъект();
    
    Если ЗаказОбъект = Неопределено Тогда
        Сообщить("Не удалось получить заказ");
        Возврат;
    КонецЕсли;
    
    // Перебираем строки заказа
    Для Каждого СтрокаЗаказа Из ЗаказОбъект.СписокИзделий Цикл
        // Получаем спецификацию
        Спецификация = СтрокаЗаказа.Спецификации;
        
        Если Не ЗначениеЗаполнено(Спецификация) Тогда
            Сообщить("Для изделия " + СтрокаЗаказа.Номенклатура + " не указана спецификация");
            Продолжить;
        КонецЕсли;
        
        // Получаем объект спецификации
        СпецификацияОбъект = Спецификация.ПолучитьОбъект();
        
        // Создаем документ выполнения этапа
        ДокЭтап = Документы.ВыполениеЭтапаПроизводства.СоздатьДокумент();
        
        // Заполняем шапку
        ДокЭтап.Дата = ТекущаяДата();
        ДокЭтап.Заказ = Заказ;
        ДокЭтап.Номенклатура = СтрокаЗаказа.Номенклатура;
        ДокЭтап.Количество = СтрокаЗаказа.Количество;
        ДокЭтап.Статус = Перечисления.СтатусЭтапаПроизводства.Запланирован;
        
        // Заполняем материалы из спецификации
        Для Каждого СтрокаМатериала Из СпецификацияОбъект.Материалы Цикл
            НоваяСтрока = ДокЭтап.ЗатраченныеМатериалы.Добавить();
            НоваяСтрока.ЗатраченныеМатериалы = СтрокаМатериала.Материал;
            НоваяСтрока.Количество = СтрокаМатериала.Количество * СтрокаЗаказа.Количество;
            НоваяСтрока.ЕдиницаИзмерения = СтрокаМатериала.Единица_Измерения;
        КонецЦикла;
        
        // Заполняем трудозатраты из спецификации (без бригад)
        Для Каждого СтрокаТрудозатрат Из СпецификацияОбъект.ТрудозатратыПоЭтапам Цикл
            НоваяСтрока = ДокЭтап.Трудозатраты.Добавить();
            НоваяСтрока.ВидРаботы = СтрокаТрудозатрат.ВидРабот;
            НоваяСтрока.Время = СтрокаТрудозатрат.ТребуемоеВремяВыполнения * СтрокаЗаказа.Количество;
            // Бригаду не заполняем
        КонецЦикла;
        
        // Записываем документ без проведения
        ДокЭтап.Записать(РежимЗаписиДокумента.Запись);
        
    КонецЦикла;
    
    Сообщить("Этапы производства сформированы");
КонецПроцедуры