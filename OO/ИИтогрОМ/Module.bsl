// ИИКлиентСервер - общий модуль для работы с сервисами ИИ
// Содержит функции отправки запросов и обработки ответов

////////////////////////////////////////////////////////////////////////////////
// Публичные функции

// Получает настройки подключения к ИИ
// Возвращаемое значение: Структура - настройки подключения
Функция ПолучитьНастройкиИИ() Экспорт
    Настройки = Новый Структура;
    
    // Пробуем получить настройки из регистра сведений
    Попытка
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |   Настройки.АдресСервера КАК АдресСервера,
        |   Настройки.Модель КАК Модель,
        |   Настройки.Таймаут КАК Таймаут
        |ИЗ
        |   РегистрСведений.НастройкиИИ КАК Настройки";
        
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        Если Выборка.Следующий() Тогда
            Настройки.Вставить("АдресСервера", Выборка.АдресСервера);
            Настройки.Вставить("Модель", Выборка.Модель);
            Настройки.Вставить("Таймаут", Выборка.Таймаут);
            Возврат Настройки;
        КонецЕсли;
    Исключение
        // Если регистра нет, используем значения по умолчанию
    КонецПопытки;
    
    // Значения по умолчанию
	Настройки.Вставить("АдресСервера", "localhost:1234");
	Настройки.Вставить("Модель", "qwen/qwen3-vl:8b");
	Настройки.Вставить("Таймаут", 1);
    
    Возврат Настройки;
КонецФункции

// Отправляет запрос к ИИ и получает ответ
// Параметры:
//   ТекстЗапроса - Строка - текст запроса к ИИ
//   СистемнаяИнструкция - Строка - дополнительная инструкция для ИИ
// Возвращаемое значение: Строка - ответ от ИИ или Неопределено в случае ошибки
Функция ОтправитьЗапросИИ(Знач ТекстЗапроса, Знач СистемнаяИнструкция = "") Экспорт
    Настройки = ПолучитьНастройкиИИ();
    
    // Формируем полный промпт с контекстом
    ПолныйЗапрос = СистемнаяИнструкция + ТекстЗапроса;
    
    // Логируем запрос
    ЗаписьЖурналаРегистрации("ИИ-Ассистент", УровеньЖурналаРегистрации.Информация,,,
        "Отправка запроса к ИИ. Модель: " + Настройки.Модель);
    
    Попытка
        Результат = ОтправитьЗапросOllama(Настройки.АдресСервера, ПолныйЗапрос, Настройки.Модель);
        
        Если Результат = Неопределено Тогда
            ЗаписьЖурналаРегистрации("ИИ-Ассистент", УровеньЖурналаРегистрации.Ошибка,,,
                "Пустой ответ от ИИ");
            Возврат Неопределено;
        КонецЕсли;
        
        // Логируем успешный ответ (обрезаем длинный текст)
        КороткийОтвет = Лев(Результат, 200);
        ЗаписьЖурналаРегистрации("ИИ-Ассистент", УровеньЖурналаРегистрации.Информация,,,
            "Получен ответ от ИИ: " + КороткийОтвет);
        
        Возврат Результат;
    Исключение
        ТекстОшибки = ОписаниеОшибки();
        ЗаписьЖурналаРегистрации("ИИ-Ассистент", УровеньЖурналаРегистрации.Ошибка,,,
            "Ошибка при вызове ИИ: " + ТекстОшибки);
        Возврат Неопределено;
    КонецПопытки;
КонецФункции

// Отправляет запрос к локальному серверу Ollama
// Параметры:
//   АдресСервера - Строка - адрес сервера Ollama (например "localhost:11434")
//   ЗапросТекст - Строка - текст запроса
//   Модель - Строка - название модели
// Возвращаемое значение: Строка - ответ от модели
Функция ОтправитьЗапросOllama(Знач АдресСервера, Знач ЗапросТекст, Знач Модель = "qwen3-vl:8b") Экспорт
    
    // Создаем HTTP соединение
    Попытка
        Соединение = Новый HTTPСоединение(АдресСервера);
    Исключение
        ЗаписьЖурналаРегистрации("ИИ-Ассистент", УровеньЖурналаРегистрации.Ошибка,,,
            "Не удалось подключиться к серверу Ollama по адресу: " + АдресСервера);
        ВызватьИсключение "Не удалось подключиться к серверу ИИ. Проверьте адрес: " + АдресСервера;
    КонецПопытки;
    
    // Создаем заголовки запроса
    Заголовки = Новый Соответствие;
    Заголовки.Вставить("Content-Type", "application/json");
	
	// Создаем структуру данных для Ollama API
	// Формируем сообщения для OpenAI-совместимого API
	Сообщения = Новый Массив;
	СообщениеПользователя = Новый Структура;
	СообщениеПользователя.Вставить("role", "user");
	СообщениеПользователя.Вставить("content", ЗапросТекст);
	Сообщения.Добавить(СообщениеПользователя);
	
	Данные = Новый Структура();
	Данные.Вставить("model", Модель);
	Данные.Вставить("messages", Сообщения);
	Данные.Вставить("stream", Ложь);
	Данные.Вставить("temperature", 0.7);
	
	//Данные.Вставить("think", Ложь);
    
    // Создаем JSON из тела запроса
    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.УстановитьСтроку();
    ЗаписатьJSON(ЗаписьJSON, Данные);
    ТелоЗапроса = ЗаписьJSON.Закрыть();
    
    // Создаем запрос к API Ollama
    АдресЗапроса = "/v1/chat/completions";
    Запрос = Новый HTTPЗапрос(АдресЗапроса);
    Запрос.Заголовки = Заголовки;
    Запрос.УстановитьТелоИзСтроки(ТелоЗапроса, "UTF-8", ИспользованиеByteOrderMark.НеИспользовать);
    
    // Отправляем запрос
    Попытка
        Ответ = Соединение.ВызватьHTTPМетод("POST", Запрос);
    Исключение
        ЗаписьЖурналаРегистрации("ИИ-Ассистент", УровеньЖурналаРегистрации.Ошибка,,,
            "Ошибка HTTP запроса к Ollama: " + ОписаниеОшибки());
        ВызватьИсключение "Ошибка при отправке запроса к серверу ИИ";
    КонецПопытки;
    
    Если Ответ.КодСостояния <> 200 Тогда
        ЗаписьЖурналаРегистрации("ИИ-Ассистент", УровеньЖурналаРегистрации.Ошибка,,,
            "Сервер вернул код состояния: " + Ответ.КодСостояния);
        ВызватьИсключение "Сервер ИИ вернул ошибку. Код: " + Ответ.КодСостояния;
    КонецЕсли;
    
    // Получаем ответ как строку
    ТекстОтвета = Ответ.ПолучитьТелоКакСтроку("UTF-8");
    
    // Парсим JSON ответ
    Попытка
        ЧтениеJSON = Новый ЧтениеJSON;
        ЧтениеJSON.УстановитьСтроку(ТекстОтвета);
		ОтветJSON = ПрочитатьJSON(ЧтениеJSON);
		
		// Для OpenAI-совместимого API ответ приходит в другом формате
		Если ОтветJSON.Свойство("choices") Тогда
			Выборка = ОтветJSON.choices;
			Если Выборка.Количество() > 0 Тогда
				ТекстОтветаAI = Выборка[0].message.content;
			КонецЕсли;
		КонецЕсли;
    Исключение
        ЗаписьЖурналаРегистрации("ИИ-Ассистент", УровеньЖурналаРегистрации.Ошибка,,,
            "Ошибка парсинга JSON ответа: " + ОписаниеОшибки());
        ВызватьИсключение "Ошибка при обработке ответа от ИИ";
    КонецПопытки;
    
    Возврат ТекстОтветаAI;
КонецФункции

// Очищает JSON строку от лишних символов и форматирования
// Параметры:
//   JSONСтрока - Строка - сырой JSON от ИИ
// Возвращаемое значение: Строка - очищенный JSON
Функция ОчиститьJSON(Знач JSONСтрока) Экспорт
    // Удаляем markdown-разметку если есть
    JSONСтрока = СтрЗаменить(JSONСтрока, "```json", "");
    JSONСтрока = СтрЗаменить(JSONСтрока, "```", "");
    
    // Удаляем лишние пробелы и переносы в начале и конце
    JSONСтрока = СокрЛП(JSONСтрока);
    
    Возврат JSONСтрока;
КонецФункции

// Сохраняет промпт в историю для отладки
// Параметры:
//   ТипЗапроса - Строка - тип запроса (генерация, прогноз и т.д.)
//   Промпт - Строка - текст запроса
//   Ответ - Строка - ответ от ИИ
Процедура СохранитьВИсторию(Знач ТипЗапроса, Знач Промпт, Знач Ответ) Экспорт
    // Здесь можно сохранять в регистр сведений для анализа
    // Но пока просто пишем в журнал
    ЗаписьЖурналаРегистрации("ИИ-Ассистент", УровеньЖурналаРегистрации.Информация,,,
        ТипЗапроса + " | Промпт: " + Лев(Промпт, 100) + "... | Ответ: " + Лев(Ответ, 100) + "...");
КонецПроцедуры