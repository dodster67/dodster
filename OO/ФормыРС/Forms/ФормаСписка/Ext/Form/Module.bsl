&НаКлиенте
Процедура ПриОткрытии(Отказ)
    
    // Показываем подсказку для импорта фотографий
	//Сообщить("─────────────────────────────");
	//Сообщить(" ИМПОРТ ФОТОГРАФИЙ:");
	//Сообщить("Внимание! При нажатии кнопки 'Импорт фотографий'");
    Сообщить("Выберите ЛЮБОЙ файл в нужной папке.");
    Сообщить("Программа автоматически определит папку и обработает все фотографии в ней.");
	//Сообщить("...все фотографии в ней.");
	//Сообщить("─────────────────────────────");
    
КонецПроцедуры

&НаКлиенте
Асинх Процедура ИмпортФотографий(Команда)
    
    // === ШАГ 1: Выбор папки с фотографиями ===
    Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
    Диалог.Заголовок = "Выберите ЛЮБОЙ файл в папке с фотографиями";
    Диалог.Каталог = "C:\";
    
    // Пытаемся установить режим выбора каталога
    Попытка
        Диалог.Режим = РежимДиалогаВыбораФайла.ВыборКаталога;
    Исключение
        // Если не поддерживается, просто продолжим
    КонецПопытки;
    
    // Показываем диалог и ждем выбора
    Результат = Ждать Диалог.ВыбратьАсинх();
    Если Результат = Неопределено Тогда
        Возврат; // Пользователь отменил
    КонецЕсли;
    
    // Определяем путь к папке
    ПутьКПапке = "";
    Попытка
        // Пытаемся получить как папку
        ПутьКПапке = Диалог.Каталог;
    Исключение
        // Если не получилось, берем путь из выбранного файла
        ПутьКПапке = ПолучитьПутьИзПолногоИмени(Диалог.ПолноеИмяФайла);
    КонецПопытки;
    
    Если ПустаяСтрока(ПутьКПапке) Тогда
        Сообщить("Не удалось определить папку!");
        Возврат;
    КонецЕсли;
    
    Сообщить(" Выбрана папка: " + ПутьКПапке);
    
    // Вызываем серверную функцию
    Результаты = ИмпортФотографийНаСервере(ПутьКПапке);
    
    // Показываем результаты
	//Сообщить("─────────────────────────────");
	//Сообщить(" ИМПОРТ ЗАВЕРШЕН!");
    Сообщить("Успешно загружено: " + Результаты.Успешно);
    Сообщить("Не найдено артикулов: " + Результаты.НеНайдено);
    Сообщить("Пропущено (не картинки): " + Результаты.НеКартинка);
    Сообщить(" Всего файлов в папке: " + Результаты.ВсегоФайлов);
    
    Если Результаты.НеНайдено > 0 Тогда
        Сообщить(" Файлы с ненайденными артикулами перемещены в папку 'не распознаны'");
    КонецЕсли;
	//Сообщить("─────────────────────────────");
    
    // Обновляем список
    Элементы.Список.Обновить();
    
КонецПроцедуры

&НаСервере
Функция ИмпортФотографийНаСервере(ПутьКПапке)
    
    Результат = Новый Структура("Успешно, НеНайдено, НеКартинка, ВсегоФайлов", 0, 0, 0, 0);
    
    // Проверяем, что папка существует
    Если Не КаталогСуществует(ПутьКПапке) Тогда
        Сообщить("Выбранная папка не существует!");
        Возврат Результат;
    КонецЕсли;
    
    // Создаем папку для нераспознанных
    ПутьКНераспознанным = ПутьКПапке + "\не распознаны";
    Если Не КаталогСуществует(ПутьКНераспознанным) Тогда
        СоздатьКаталог(ПутьКНераспознанным);
        Сообщить(" Создана папка: не распознаны");
    КонецЕсли;
    
    // Получаем все файлы из папки
    ВсеФайлы = НайтиФайлы(ПутьКПапке, "*.*");
    
    // Статистика
    Успешно = 0;
    НеНайдено = 0;
    НеКартинка = 0;
    ВсегоФайлов = 0;
    
    // Обрабатываем каждый файл
    Для Каждого Файл Из ВсеФайлы Цикл
        
        // Пропускаем папки
        Если Файл.ЭтоКаталог() Тогда
            Продолжить;
        КонецЕсли;
        
        ВсегоФайлов = ВсегоФайлов + 1;
        
        // Проверяем, что это картинка
        Расширение = ВРег(Файл.Расширение);
        Если Не (Расширение = ".JPG" ИЛИ Расширение = ".JPEG" ИЛИ 
                 Расширение = ".PNG" ИЛИ Расширение = ".GIF" ИЛИ 
                 Расширение = ".BMP") Тогда
            НеКартинка = НеКартинка + 1;
            Продолжить;
        КонецЕсли;
        
        // Артикул = имя файла без расширения (это будет КОД номенклатуры)
        КодНоменклатуры = Файл.ИмяБезРасширения;
        
        // Ищем номенклатуру по КОДУ (исправлено!)
        НайденнаяНоменклатура = Справочники.Номенклатура.НайтиПоКоду(КодНоменклатуры);
        
        Попытка
    Если Не НайденнаяНоменклатура.Пустая() Тогда
        // Проверяем, есть ли уже фото у этой номенклатуры
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |   Файлы.Объект
        |ИЗ
        |   РегистрСведений.Файлы КАК Файлы
        |ГДЕ
        |   Файлы.Объект = &Номенклатура";
        
        Запрос.УстановитьПараметр("Номенклатура", НайденнаяНоменклатура);
        РезультатЗапроса = Запрос.Выполнить();
        
        Если РезультатЗапроса.Пустой() Тогда
            // Фото нет - импортируем
            ДвоичныеДанные = Новый ДвоичныеДанные(Файл.ПолноеИмя);
            Размер = Файл.Размер();
            
            РегистрыСведений.Файлы.ЗаписатьФайлВБазу(
                НайденнаяНоменклатура, 
                ДвоичныеДанные, 
                Размер, 
                Файл.Расширение
            );
            
            Успешно = Успешно + 1;
            Сообщить("Импортировано: " + Файл.Имя + " → " + НайденнаяНоменклатура.Наименование);
        Иначе
            // Фото уже есть - пропускаем
            Сообщить("У номенклатуры " + КодНоменклатуры + " уже есть фото, пропущен: " + Файл.Имя);
        КонецЕсли;
        
        // Удалять файл НЕ нужно, он остается в папке
        
    Иначе
        // Код не найден - перемещаем в папку "не распознаны"
        НеНайдено = НеНайдено + 1;
        
        // Перемещаем через чтение/запись
        ДвоичныеДанные = Новый ДвоичныеДанные(Файл.ПолноеИмя);
        ДвоичныеДанные.Записать(ПутьКНераспознанным + "\" + Файл.Имя);
        
        // Удаляем исходный файл
        УдалитьФайлы(Файл.ПолноеИмя);
    КонецЕсли;
Исключение
    Сообщить("Ошибка при обработке файла " + Файл.Имя + ": " + ОписаниеОшибки());
КонецПопытки;
        
    КонецЦикла;
    
    Результат.Успешно = Успешно;
    Результат.НеНайдено = НеНайдено;
    Результат.НеКартинка = НеКартинка;
    Результат.ВсегоФайлов = ВсегоФайлов;
    
    Возврат Результат;
    
КонецФункции

// Вспомогательные функции
&НаСервере
Функция ПолучитьПутьИзПолногоИмени(ПолноеИмяФайла)
    Файл = Новый Файл(ПолноеИмяФайла);
    Возврат Файл.Путь;
КонецФункции

&НаСервере
Функция КаталогСуществует(Путь)
    Файл = Новый Файл(Путь);
    Возврат Файл.Существует();
КонецФункции