&НаКлиенте
Процедура ПриОткрытии(Отказ)
	Объект.ПериодПрогнозаМесяцев = 3;
КонецПроцедуры

&НаКлиенте
Процедура ВыполнитьПрогноз(Команда)
	Если Объект.ПериодПрогнозаМесяцев < 1 ИЛИ Объект.ПериодПрогнозаМесяцев > 6 Тогда
		Сообщить("Период прогноза должен быть от 1 до 6 месяцев");
		Возврат;
	КонецЕсли;
	
	Попытка
		// Очищаем таблицу
		Объект.ТЧРезультат.Очистить();
		
		// Выполняем прогноз для ВСЕХ материалов
		ВыполнитьПрогнозНаСервере();
		
		Сообщить("Прогноз выполнен");
		
	Исключение
		Сообщить("Ошибка: " + ОписаниеОшибки());
	КонецПопытки;
КонецПроцедуры

&НаСервере
Процедура ВыполнитьПрогнозНаСервере()
	// Дата начала анализа - 2 года назад
	ДатаНачалаАнализа = ДобавитьМесяц(НачалоМесяца(ТекущаяДата()), -24);
	
	// Получаем ВСЕ материалы, по которым были заказы
	ЗапросМатериалы = Новый Запрос;
	ЗапросМатериалы.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|   СпецификацииМатериалы.Материал КАК Материал
	|ИЗ
	|   Документ.Заказ КАК Заказ
	|       ЛЕВОЕ СОЕДИНЕНИЕ Документ.Заказ.СписокИзделий КАК ЗаказыСписок
	|           ПО Заказ.Ссылка = ЗаказыСписок.Ссылка
	|       ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Спецификации.Материалы КАК СпецификацииМатериалы
	|           ПО ЗаказыСписок.Спецификации = СпецификацииМатериалы.Ссылка
	|ГДЕ
	|   Заказ.Дата >= &ДатаНачала
	|   И Заказ.Проведен
	|   И НЕ Заказ.ПометкаУдаления
	|   И СпецификацииМатериалы.Материал ЕСТЬ НЕ NULL";
	
	ЗапросМатериалы.УстановитьПараметр("ДатаНачала", ДатаНачалаАнализа);
	РезультатМатериалы = ЗапросМатериалы.Выполнить();
	ВыборкаМатериалы = РезультатМатериалы.Выбрать();
	
	// Для каждого материала собираем статистику
	Пока ВыборкаМатериалы.Следующий() Цикл
		Материал = ВыборкаМатериалы.Материал;
		
		// Получаем помесячную статистику для этого материала
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|   МЕСЯЦ(Заказ.Дата) КАК Месяц,
		|   ГОД(Заказ.Дата) КАК Год,
		|   СУММА(СпецификацииМатериалы.Количество * ЗаказыСписок.Количество) КАК Потребность
		|ИЗ
		|   Документ.Заказ КАК Заказ
		|       ЛЕВОЕ СОЕДИНЕНИЕ Документ.Заказ.СписокИзделий КАК ЗаказыСписок
		|           ПО Заказ.Ссылка = ЗаказыСписок.Ссылка
		|       ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Спецификации.Материалы КАК СпецификацииМатериалы
		|           ПО ЗаказыСписок.Спецификации = СпецификацииМатериалы.Ссылка
		|ГДЕ
		|   Заказ.Дата >= &ДатаНачала
		|   И Заказ.Проведен
		|   И НЕ Заказ.ПометкаУдаления
		|   И СпецификацииМатериалы.Материал = &Материал
		|
		|СГРУППИРОВАТЬ ПО
		|   МЕСЯЦ(Заказ.Дата),
		|   ГОД(Заказ.Дата)
		|
		|УПОРЯДОЧИТЬ ПО
		|   Год, Месяц";
		
		Запрос.УстановитьПараметр("ДатаНачала", ДатаНачалаАнализа);
		Запрос.УстановитьПараметр("Материал", Материал);
		
		Результат = Запрос.Выполнить();
		ВыборкаДанных = Результат.Выбрать();
		
		// Формируем массивы данных для ИИ
		Месяцы = Новый Массив;
		Потребности = Новый Массив;
		
		Пока ВыборкаДанных.Следующий() Цикл
			ДатаМесяца = Дата(ВыборкаДанных.Год, ВыборкаДанных.Месяц, 1);
			Месяцы.Добавить(ДатаМесяца);
			Потребности.Добавить(ВыборкаДанных.Потребность);
		КонецЦикла;
		
		// Если есть исторические данные, делаем прогноз
		Если Месяцы.Количество() > 0 Тогда
			Прогноз = ПрогнозироватьПотребностьИИ(Материал, Месяцы, Потребности, Объект.ПериодПрогнозаМесяцев);
			
			Если Прогноз <> Неопределено Тогда
				// Получаем текущий остаток
				// Получаем текущий остаток
				ТекущийОстаток = ПолучитьТекущийОстаток(Материал);
				
				// Добавляем строки в результат для каждого месяца прогноза
				ОстатокНаНачалоМесяца = ТекущийОстаток;
				НакопленнаяПотребность = 0;
				
				Для Индекс = 0 По Прогноз.Потребности.Количество() - 1 Цикл
					ДатаПрогноза = ДобавитьМесяц(НачалоМесяца(ТекущаяДата()), Индекс + 1);
					
					НоваяСтрока = Объект.ТЧРезультат.Добавить();
					НоваяСтрока.Материал = Материал;
					НоваяСтрока.НаименованиеМатериала = Материал.Наименование;
					НоваяСтрока.Месяц = ДатаПрогноза;
					НоваяСтрока.Потребность = Прогноз.Потребности[Индекс];
					НоваяСтрока.ПроцентУверенности = Прогноз.Уверенность;
					
					// Текущий остаток на начало месяца
					НоваяСтрока.ТекущийОстаток = ОстатокНаНачалоМесяца;
					
					// Прогноз остатка на конец месяца
					НакопленнаяПотребность = НакопленнаяПотребность + Прогноз.Потребности[Индекс];
					НоваяСтрока.ПрогнозОстатка = ТекущийОстаток - НакопленнаяПотребность;
					
					// Для следующего месяца текущий остаток = прогноз остатка текущего месяца
					ОстатокНаНачалоМесяца = НоваяСтрока.ПрогнозОстатка;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

// Остальные функции (ПрогнозироватьПотребностьИИ, ПолучитьТекущийОстаток) остаются без изменений
&НаСервере
Функция ПрогнозироватьПотребностьИИ(Материал, Месяцы, Потребности, МесяцевПрогноза)
	// Формируем строку с историческими данными
	СтрокаДанных = "";
	Для Индекс = 0 По Месяцы.Количество() - 1 Цикл
		СтрокаДанных = СтрокаДанных + Формат(Месяцы[Индекс], "ДФ=yyyy-MM") + ": " + Строка(Потребности[Индекс]) + Символы.ПС;
	КонецЦикла;
	
	// Формируем промпт для ИИ
	Промпт = СтрШаблон("
	|Проанализируй исторические данные потребления материала '%1' за последние месяцы:
	|
	|%2
	|
	|Сделай прогноз потребности на %3 месяцев вперед.
	|Оцени процент уверенности прогноза от 0 до 100 (чем стабильнее тренд, тем выше процент).
	|
	|ВАЖНО: Верни результат строго в формате JSON:
	|{
	|   'Потребности': [числа на каждый месяц прогноза],
	|   'Уверенность': число
	|}
	|
	|Пример ответа: {'Потребности': [150, 155, 160], 'Уверенность': 85}
	|", Материал.Наименование, СтрокаДанных, МесяцевПрогноза);
	
	// Отправляем запрос к ИИ
	Ответ = ИИКлиентСервер.ОтправитьЗапросИИ(Промпт);
	
	Если Ответ = Неопределено Тогда
		Сообщить("Не удалось получить прогноз для материала " + Материал.Наименование);
		Возврат Неопределено;
	КонецЕсли;
	
	// Для отладки - показываем сырой ответ	
	// Очищаем JSON
	Ответ = ИИКлиентСервер.ОчиститьJSON(Ответ);
	
	// Парсим ответ
	Попытка
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(Ответ);
		Результат = ПрочитатьJSON(ЧтениеJSON);
		
		// Проверяем структуру
		Если Результат.Свойство("Потребности") = Ложь Тогда
			ВызватьИсключение("В ответе нет поля 'Потребности'");
		КонецЕсли;
		
		Если Результат.Свойство("Уверенность") = Ложь Тогда
			// Если нет уверенности, ставим 50%
			Результат.Вставить("Уверенность", 50);
		КонецЕсли;
		
		Возврат Результат;
	Исключение
		Сообщить("Ошибка обработки прогноза для " + Материал.Наименование + ": " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
КонецФункции

//&НаКлиенте
//Процедура ПостроитьГрафик()
//    Попытка
//        // Проверяем, что выбран материал
//        Если Объект.МатериалДляАнализа = Неопределено Тогда
//            Возврат;
//        КонецЕсли;
//        
//        // Получаем элемент диаграммы
//        Диаграмма = Элементы.ДиаграммаОстатков;
//        
//        // Очищаем диаграмму
//        Диаграмма.Очистить();
//        
//        // Настраиваем диаграмму
//        Диаграмма.ТипДиаграммы = ТипДиаграммы.График;
//        Диаграмма.Заголовок = "Прогноз остатков: " + Объект.МатериалДляАнализа.Наименование;
//        
//        // Получаем данные из таблицы
//        ТЗ = Объект.ТЧРезультат.Выгрузить();
//        
//        // Добавляем серии
//        СерияТекущий = Диаграмма.ДобавитьСерию("Текущий остаток");
//        СерияПрогноз = Диаграмма.ДобавитьСерию("Прогноз остатка");
//        
//        // Сортируем данные по месяцу
//        ТЗ.Сортировать("Месяц");
//        
//        // Добавляем точки и значения
//        Для Каждого Строка Из ТЗ Цикл
//            // Добавляем точку с названием месяца
//            Точка = Диаграмма.Точки.Добавить(Формат(Строка.Месяц, "ДФ=MM.yyyy"));
//            
//            // Устанавливаем значения
//            Диаграмма.УстановитьЗначениеТочки(СерияТекущий, Точка, Строка.ТекущийОстаток);
//            Диаграмма.УстановитьЗначениеТочки(СерияПрогноз, Точка, Строка.ПрогнозОстатка);
//        КонецЦикла;
//        
//        Если Диаграмма.Точки.Количество() = 0 Тогда
//            Сообщить("Нет данных для построения графика");
//        КонецЕсли;
//        
//    Исключение
//        Сообщить("Ошибка при построении графика: " + ОписаниеОшибки());
//    КонецПопытки;
//КонецПроцедуры

&НаСервере
Функция ПолучитьТекущийОстаток(Материал)
	Попытка
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|   СкладМатериаловОстатки.КоличествоОстаток КАК Остаток
		|ИЗ
		|   РегистрНакопления.СкладМатериалов.Остатки() КАК СкладМатериаловОстатки
		|ГДЕ
		|   СкладМатериаловОстатки.Номенклатура = &Материал";
		
		Запрос.УстановитьПараметр("Материал", Материал);
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		
		Если Выборка.Следующий() Тогда
			Возврат Выборка.Остаток;
		КонецЕсли;
	Исключение
		// Если регистра нет или ошибка
		Возврат 1000; // Для теста
	КонецПопытки;
	
	Возврат 0;
КонецФункции

&НаКлиенте
Процедура ТЧРезультатПриАктивизацииСтроки(Элемент)
	// При выборе строки в таблице строим график для этого материала
	ТекущаяСтрока = Элементы.ТЧРезультат.ТекущиеДанные;
	Если ТекущаяСтрока <> Неопределено Тогда
		Объект.МатериалДляАнализа = ТекущаяСтрока.Материал;
		//ПостроитьГрафик();
	КонецЕсли;
КонецПроцедуры  



