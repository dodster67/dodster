Функция ПолучитьНоменклатуруДляПриложения() Экспорт
	Возврат ЗаписатьЗначениеJSON(ПолучитьНоменклатураМассивом());
КонецФункции // ПолучитьТоварДляПриложения()

Функция ПолучитьБригадуДляПриложения() Экспорт
	Возврат ЗаписатьЗначениеJSON(ПолучитьБригадуМассивом());
КонецФункции // ПолучитьБригадуДляПриложения()

Функция ПолучитьЭтапыДляПриложения() Экспорт
	Возврат ЗаписатьЗначениеJSON(ПолучитьЭтапыМассивом());
КонецФункции // ПолучитьБригадуДляПриложения()


Функция ПолучитьНоменклатураМассивом() Экспорт

		//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!

	МассивНоменклатура = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Код КАК Код,
		|	Номенклатура.Наименование КАК Наименование,
		|	Номенклатура.Тип КАК Тип,
		|	Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура";
	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Номенклатура = Новый Структура("Код, Наименование, Тип, ЕдиницаИзмерения");
		ЗаполнитьЗначенияСвойств(Номенклатура, ВыборкаДетальныеЗаписи);
		Номенклатура.Тип = Строка(Номенклатура.Тип);
		Номенклатура.ЕдиницаИзмерения = Строка(Номенклатура.ЕдиницаИзмерения);
		МассивНоменклатура.Добавить(Номенклатура);
	КонецЦикла;
	
	Возврат МассивНоменклатура;
	
		

КонецФункции // ПолучитьНоменклатуруМассивом()


Функция ПолучитьБригадуМассивом() Экспорт
    
    МассивБригад = Новый Массив;
    
    // Получаем все корневые элементы
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ
        |    Рабочая_бригада.Ссылка КАК Ссылка,
        |    Рабочая_бригада.Код КАК Код,
        |    Рабочая_бригада.Наименование КАК Наименование,
        |    Рабочая_бригада.ЭтоГруппа КАК ЭтоГруппа
        |ИЗ
        |    Справочник.Рабочая_бригада КАК Рабочая_бригада
        |ГДЕ
        |    Рабочая_бригада.Родитель = ЗНАЧЕНИЕ(Справочник.Рабочая_бригада.ПустаяСсылка)
        |    И Рабочая_бригада.ПометкаУдаления = ЛОЖЬ";
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    Пока Выборка.Следующий() Цикл
        СтруктураБригады = Новый Структура;
        СтруктураБригады.Вставить("Код", Выборка.Код);
        СтруктураБригады.Вставить("Наименование", Выборка.Наименование);
        СтруктураБригады.Вставить("ЭтоГруппа", Выборка.ЭтоГруппа);
        СтруктураБригады.Вставить("Подчиненные", ПолучитьПодчиненныеБригады(Выборка.Ссылка));
        
        МассивБригад.Добавить(СтруктураБригады);
    КонецЦикла;
    
    Возврат МассивБригад;
    
КонецФункции

Функция ПолучитьПодчиненныеБригады(Родитель)
    
    МассивПодчиненных = Новый Массив;
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ
        |    Рабочая_бригада.Ссылка,  // <- ДОБАВИТЬ ЭТО!
        |    Рабочая_бригада.Код,
        |    Рабочая_бригада.Наименование,
        |    Рабочая_бригада.ЭтоГруппа
        |ИЗ
        |    Справочник.Рабочая_бригада КАК Рабочая_бригада
        |ГДЕ
        |    Рабочая_бригада.Родитель = &Родитель
        |    И Рабочая_бригада.ПометкаУдаления = ЛОЖЬ";
    
    Запрос.УстановитьПараметр("Родитель", Родитель);
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    Пока Выборка.Следующий() Цикл
        СтруктураБригады = Новый Структура;
        СтруктураБригады.Вставить("Код", Выборка.Код);
        СтруктураБригады.Вставить("Наименование", Выборка.Наименование);
        СтруктураБригады.Вставить("ЭтоГруппа", Выборка.ЭтоГруппа);
        СтруктураБригады.Вставить("Подчиненные", ПолучитьПодчиненныеБригады(Выборка.Ссылка)); // теперь Ссылка есть
        
        МассивПодчиненных.Добавить(СтруктураБригады);
    КонецЦикла;
    
    Возврат МассивПодчиненных;
    
КонецФункции


Функция ПолучитьЭтапыМассивом() Экспорт
    МассивЭтап = Новый Массив;
	

	
	Запрос = Новый Запрос;
Запрос.Текст = 
    "ВЫБРАТЬ
    |    ВыполениеЭтапаПроизводства.Дата КАК Дата,
    |    ВыполениеЭтапаПроизводства.Проведен КАК Проведен,
    |    ВыполениеЭтапаПроизводства.Заказ КАК Заказ,
    |    ВыполениеЭтапаПроизводства.Номенклатура КАК Номенклатура,
    |    ВыполениеЭтапаПроизводства.Склад КАК Склад,
    |    ВыполениеЭтапаПроизводства.Количество КАК Количество,
    |    ВыполениеЭтапаПроизводства.Статус КАК Статус,
    |    ВыполениеЭтапаПроизводства.ЗатраченныеМатериалы.(
    |        Ссылка КАК Ссылка,
    |        НомерСтроки КАК НомерСтроки,
    |        Склад КАК СкладМатериала,
    |        ЗатраченныеМатериалы КАК Материал,
    |        ЕдиницаИзмерения КАК ЕдиницаИзмерения,
    |        Количество КАК КоличествоМатериала
    |    ) КАК ЗатраченныеМатериалы,
    |    ВыполениеЭтапаПроизводства.Трудозатраты.(
    |        Ссылка КАК Ссылка,
    |        НомерСтроки КАК НомерСтроки,
    |        ВидРаботы КАК ВидРаботы,
    |        Время КАК Время,
    |        Бригада КАК Бригада
    |    ) КАК Трудозатраты
    |ИЗ
    |    Документ.ВыполениеЭтапаПроизводства КАК ВыполениеЭтапаПроизводства";

РезультатЗапроса = Запрос.Выполнить();
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();

МассивЭтап = Новый Массив;

Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
    
    
    МассивМатериалов = Новый Массив;
    ВыборкаМатериалов = ВыборкаДетальныеЗаписи.ЗатраченныеМатериалы.Выбрать();
    
    Пока ВыборкаМатериалов.Следующий() Цикл
        Материал = Новый Структура;
        Материал.Вставить("Ссылка", Строка(ВыборкаМатериалов.Ссылка));
        Материал.Вставить("НомерСтроки", Строка(ВыборкаМатериалов.НомерСтроки));
        Материал.Вставить("Склад", Строка(ВыборкаМатериалов.СкладМатериала));
        Материал.Вставить("Материал", Строка(ВыборкаМатериалов.Материал));
        Материал.Вставить("ЕдиницаИзмерения", Строка(ВыборкаМатериалов.ЕдиницаИзмерения));
        Материал.Вставить("Количество", Строка(ВыборкаМатериалов.КоличествоМатериала));
        МассивМатериалов.Добавить(Материал);
    КонецЦикла;
    
    
    МассивТрудозатрат = Новый Массив;
    ВыборкаТрудозатрат = ВыборкаДетальныеЗаписи.Трудозатраты.Выбрать();
    
    Пока ВыборкаТрудозатрат.Следующий() Цикл
        Трудозатрата = Новый Структура;
        Трудозатрата.Вставить("Ссылка", Строка(ВыборкаТрудозатрат.Ссылка));
        Трудозатрата.Вставить("НомерСтроки", Строка(ВыборкаТрудозатрат.НомерСтроки));
        Трудозатрата.Вставить("ВидРаботы", Строка(ВыборкаТрудозатрат.ВидРаботы));
        Трудозатрата.Вставить("Время", Строка(ВыборкаТрудозатрат.Время));
        Трудозатрата.Вставить("Бригада", Строка(ВыборкаТрудозатрат.Бригада));
        МассивТрудозатрат.Добавить(Трудозатрата);
    КонецЦикла;
    
    
    Этапы = Новый Структура;
    Этапы.Вставить("Дата", Строка(ВыборкаДетальныеЗаписи.Дата));
    Этапы.Вставить("Проведен", Строка(ВыборкаДетальныеЗаписи.Проведен));
    Этапы.Вставить("Заказ", ВыборкаДетальныеЗаписи.Заказ.Номер); 
    Этапы.Вставить("Номенклатура", Строка(ВыборкаДетальныеЗаписи.Номенклатура));
    Этапы.Вставить("Склад", Строка(ВыборкаДетальныеЗаписи.Склад));
    Этапы.Вставить("Количество", Строка(ВыборкаДетальныеЗаписи.Количество));
    Этапы.Вставить("Статус", Строка(ВыборкаДетальныеЗаписи.Статус));
    Этапы.Вставить("ЗатраченныеМатериалы", МассивМатериалов);
    Этапы.Вставить("Трудозатраты", МассивТрудозатрат);             
    МассивЭтап.Добавить(Этапы);
    
КонецЦикла;
	

	
    Возврат МассивЭтап;
КонецФункции // ПолучитьЭтапыМассивом()




Процедура ЗаписатьЭтапыИзПриложения(ОписаниеЭтаповСтрокой) Экспорт
    Документы.ВыполениеЭтапаПроизводства.ЗаписатьЭтапыИзПриложения(ПрочитатьЗначениеJSON(ОписаниеЭтаповСтрокой));
КонецПроцедуры

Процедура ЗаписатьПереносИзПриложения(ОписаниеПереносаСтрокой) Экспорт
	Документы.Перенос.ЗаписатьПереносИзПриложения(ПрочитатьЗначениеJSON(ОписаниеПереносаСтрокой));
КонецПроцедуры


Процедура ЗаписатьБракИзПриложения(ОписаниеБракаСтрокой) Экспорт
	Документы.АктОБраке.ЗаписатьБракИзПриложения(ПрочитатьЗначениеJSON(ОписаниеБракаСтрокой));
КонецПроцедуры
