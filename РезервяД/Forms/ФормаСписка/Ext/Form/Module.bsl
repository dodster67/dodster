&НаКлиенте
Процедура СформироватьZIPАрхив(Команда)
    
    // Получаем выделенные документы
    ВыделенныеСтроки = Элементы.Список.ВыделенныеСтроки;
    
    Если ВыделенныеСтроки.Количество() = 0 Тогда
        Сообщить("Не выбрано ни одного документа!");
        Возврат;
    КонецЕсли;
    
    // Создаем диалог выбора файла
    Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Сохранение);
    Диалог.Заголовок = "Укажите имя файла архива";
    Диалог.Фильтр = "ZIP-архив (*.zip)|*.zip";
    Диалог.Расширение = "zip";
    Диалог.ПолноеИмяФайла = "Документы_реализации.zip";
    
    // Создаем описание оповещения для асинхронного выбора
    Оповещение = Новый ОписаниеОповещения("ПослеВыбораФайла", ЭтотОбъект, ВыделенныеСтроки);
    
    // Открываем диалог асинхронно
    Диалог.Показать(Оповещение);
    
КонецПроцедуры

&НаКлиенте
Процедура ПослеВыбораФайла(ВыбранныеФайлы, ДополнительныеПараметры) Экспорт
    
    Если ВыбранныеФайлы = Неопределено Тогда
        Возврат; // Пользователь отменил выбор
    КонецЕсли;
    
    // При сохранении возвращается массив с одним элементом
    ИмяФайлаСохранения = ВыбранныеФайлы[0];
    ВыделенныеСтроки = ДополнительныеПараметры;
    
    
    Попытка
        // Вызываем серверную функцию для формирования архива
        СформироватьАрхивПечатныхФормНаСервере(ВыделенныеСтроки, ИмяФайлаСохранения);
        
        Сообщить("Архив успешно сохранен: " + ИмяФайлаСохранения);
        
    Исключение
        Сообщить("Ошибка при формировании архива: " + ОписаниеОшибки());
    КонецПопытки;
    
    // Возвращаем доступность формы
    Элементы.Список.Доступность = Истина;
    Элементы.СформироватьZIPАрхив.Доступность = Истина;
    
КонецПроцедуры

&НаСервере
Процедура СформироватьАрхивПечатныхФормНаСервере(МассивСсылок, ПолноеИмяАрхива)
    
    // Создаем временную папку
    ВременнаяПапка = ПолучитьИмяВременногоФайла();
    СоздатьКаталог(ВременнаяПапка);
    
    // Счетчик успешных файлов
    УспешныхФайлов = 0;
    
    // Для каждого выбранного документа
    Для Каждого Ссылка Из МассивСсылок Цикл
        
        // Получаем объект документа
        ДокументОбъект = Ссылка.ПолучитьОбъект();
        
        // Формируем печатную форму
        Попытка
            ТабДок = ПолучитьПечатнуюФормуДокумента(ДокументОбъект);
        Исключение
            Сообщить("Ошибка при формировании печатной формы для документа " + ДокументОбъект.Номер + ": " + ОписаниеОшибки());
            Продолжить; // Переходим к следующему документу
        КонецПопытки;
        
        Если ТабДок <> Неопределено Тогда
            
            // Формируем имя файла
            ИмяФайла = "Реализация_№" + ДокументОбъект.Номер + "_от_" + 
                       Формат(ДокументОбъект.Дата, "ДФ=dd.MM.yyyy") + ".xlsx";
            
            // Убираем недопустимые символы из имени файла
            ИмяФайла = СтрЗаменить(ИмяФайла, "/", "-");
            ИмяФайла = СтрЗаменить(ИмяФайла, "\", "-");
            ИмяФайла = СтрЗаменить(ИмяФайла, ":", "-");
            ИмяФайла = СтрЗаменить(ИмяФайла, "*", "-");
            ИмяФайла = СтрЗаменить(ИмяФайла, "?", "-");
            ИмяФайла = СтрЗаменить(ИмяФайла, "<", "-");
            ИмяФайла = СтрЗаменить(ИмяФайла, ">", "-");
            ИмяФайла = СтрЗаменить(ИмяФайла, "|", "-");
            
            // Сохраняем во временную папку
            ПутьКФайлу = ВременнаяПапка + "\" + ИмяФайла;
            
            Попытка
                // НА КОММЕРЧЕСКОЙ ВЕРСИИ ЭТО СРАБОТАЕТ
                ТабДок.Записать(ПутьКФайлу, ТипФайлаТабличногоДокумента.XLSX);
                УспешныхФайлов = УспешныхФайлов + 1;
                Сообщить("Сохранен файл: " + ИмяФайла);
            Исключение
                Сообщить("Не удалось сохранить файл для документа " + ДокументОбъект.Номер + ": " + ОписаниеОшибки());
                // Продолжаем со следующим документом
            КонецПопытки;
            
        Иначе
            Сообщить("Не удалось получить печатную форму для документа " + ДокументОбъект.Номер);
        КонецЕсли;
        
    КонецЦикла;
    
    // Проверяем, есть ли сохраненные файлы
    Если УспешныхФайлов = 0 Тогда
        Сообщить("Не удалось сформировать ни одной печатной формы!");
        УдалитьФайлы(ВременнаяПапка);
        Возврат;
    КонецЕсли;
    
    // Создаем ZIP-архив
    Архиватор = Новый ЗаписьZipФайла(ПолноеИмяАрхива);
    
    // Находим все файлы во временной папке
    Найдено = НайтиФайлы(ВременнаяПапка, "*.*");
    
    // Добавляем все файлы из временной папки
    Для Каждого Файл Из Найдено Цикл
        Архиватор.Добавить(Файл.ПолноеИмя, 
                           РежимСохраненияПутейZIP.НеСохранятьПути, 
                           РежимОбработкиПодкаталоговZIP.НеОбрабатывать);
    КонецЦикла;
    
    // Записываем архив
    Попытка
        Архиватор.Записать();
        Сообщить("Создан архив с " + УспешныхФайлов + " файлами");
    Исключение
        Сообщить("Ошибка при создании архива: " + ОписаниеОшибки());
    КонецПопытки;
    
    // Удаляем временную папку
    УдалитьФайлы(ВременнаяПапка);
    
КонецПроцедуры

&НаСервере
Функция ПолучитьПечатнуюФормуДокумента(ДокументОбъект)
    
    Если ДокументОбъект = Неопределено Тогда
        Возврат Неопределено;
    КонецЕсли;
    
    Попытка
        // Создаем табличный документ, в который будет выведена печатная форма
        ТабДок = Новый ТабличныйДокумент;
        
        // Вызываем процедуру печати, передавая ей табличный документ
        Документы.Реализация.Печать(ТабДок, ДокументОбъект.Ссылка);
        
        // Проверяем, что что-то вывелось
        Если ТабДок.ВысотаТаблицы > 0 Тогда
            Сообщить("Сформирована печатная форма для документа " + ДокументОбъект.Номер);
            Возврат ТабДок;
        КонецЕсли;
    Исключение
        Сообщить("Ошибка при печати: " + ОписаниеОшибки());
    КонецПопытки;
    
    Возврат Неопределено;
    
КонецФункции